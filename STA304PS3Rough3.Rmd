---
title: "STA304PS3RoughR2"
output: pdf_document
---


```{r}
library(tidyverse)
library(janitor)
library(dplyr)
library(MASS)
library(survey)
library(jtools)
library(broom.mixed)
library(ResourceSelection)
library(boot)
library(ggstance)
```

## Abstract

The negative value suggests an inverse relationship between the education level and the number of children in the family.

## Introduction

The Canadian General Social Survey is a program conducted by Statistics Canada that aims to gather data through a series of annually independent, cross-sectional surveys, on social trends, exploring specific themes in depth. The objective is to monitor changes in the living conditions of Canadian citizens and provide information on key social policy issues. Initially, using the Random Digit Dialling method to gather data from Canadian citizens aged 15 years and over, living in private households in each of the provinces, the mode of collection has now changed to Computer Assisted Telephone Interviewing and internet questionnaires.
 
 The GSS focuses on several specific themes such as caregiving and care receiving and families, to name a few. It is quite common for individuals to determine their family size based on their earning capacity and age. Higher levels of maturity, as well as education, inclines towards practical family planning, especially on the part of the present generation.  In this paper, we aim to explore the independent variables such as education, income and age and their relationship with regards to the total children in a family. We are using a negative binomial distribution in order to create an appropriate regression model with our cleaned data, obtained from the GSS dataset. This model will aid the understanding of the current social trends involving family planning.
 
 Since there were a lot of NA values in the dataset, we had to clean up the data set and filter out the variables we required for our analysis, as described in the model development section of the paper. We chose to use a generalized linear model for the regression analysis as our sample represents a negative probability distribution. After validating our model and running the analysis, we discovered the estimates, standard deviations, z-value and p-value of each of our respective independent variables, namely age, and respondents’ income and education levels, respectively. The results section of the paper displays the values obtained. Our model suggests varying degrees of relationship between the total number of children in a family and the predictor variables. It also highlights variability covered in the survey as further discussed in the discussion section.
 
 In conclusion, we see that age is a very strong predictor of the total number of children in a family compared to the income level and the respondents' education level. This makes sense as it is obvious that as a person ages they might choose to have more children and engage in appropriate family planning with maturity. However, we do acknowledge the limitations of the model as mentioned in the weaknesses section. For example, there is biasedness in the data due to a single collection method. Considering the age group and the absence of access to mobile phones are some limitations that need to be dealt with although the results of this analysis should provide a reference to the relationship between the total number of children in families and the respondents’ age, income level and education level.




## Data Discussion

The data we used in this paper were collected by Canadian General Social Survey Program back in 2017. The 2017 GSS is a sample survey with cross-sectional design. The target population includes all non-institutionalized persons 15 years of age and older, living in the 10 provinces of Canada. This survey included more than 400 variables ranging from educational background to demographic characteristics.

```{r}
gss <- read_csv('gss.csv')
head(gss)
```


To carry out sampling, each of the ten provinces were divided into strata (i.e., geographic areas). Many of the Census Metropolitan Areas (CMAs) were each considered separate strata. Compared with the previous survey, the advantages of the 2017 GSS survey are many survey specific socio-demographic questions were replaced by Statistics Canada's harmonized content questions (i.e., standardized modules for household survey variables, such as marital status, education, and labour force) and the 2017 GSS on Families uses the redesigned GSS frame, which integrates data from sources of telephone numbers (landline and cellular) available to Statistics Canada and the Address Register.

 In addition, the non-response problem was well handled . The non-response adjustment was done in three stages. In the first stage, adjustments were made for complete non-response. This was done within each stratum. In the second stage, adjustments were made for non-response with auxiliary information from sources available to Statistics Canada. These households had some auxiliary information which was used to model propensity to respond. In the third stage, adjustments were made for partial non-response. These households had some auxiliary information which was used to model propensity to respond.

 However, most of the variables needed to be understood in the survey dictionary, so with the help of Professor Rohan Alexander, we reduced the number of variables we were interested in to 81.In this paper, we will focus on the three variables: age, income, and education and we want to determine the relationship between these three variables and total number of children in a family.

```{r}
## age ditribution 
gss %>% 
  ggplot(aes(x=age)) + 
  geom_bar(colour="black", fill = 'blue') + 
  scale_x_binned(name="age") + 
  labs(x = 'Age', 
       y="Number of Respondents",
       title="Graph 1: Age Distribution Among Respondents",
       caption= "Source: Statistics Canada. (2017). General social survey(GSS)") + 
  theme_minimal()
```


 As shown in graph 1, the largest proportion of respondents were over the age of 50, with the highest number of respondents between the ages of 60 to 70. In contrast, we see the smallest number of respondents below the age of 20. Thus, the proportion of older respondents greatly outweighs the proportion of younger respondents to the the survey. 
 Older respondents have often reached the final number of children they will have, whereas the younger proportion will likely parent more children in the future. This may cause some disruptions to our model's strength as younger respondents with similar degrees and income levels to older respondents will likely have different numbers of children. As a result of this, we may see a slight underestimation of the strengths of these predictors.
 
```{r}
# Total children distribution
gss %>% ggplot(aes(x=total_children)) +
  geom_bar(colour="black", fill = 'blue') + 
  labs(y="Number of people",
       title="Graph 2: Total children distribution among respondents", 
       caption= "Source:Statistics Canada. (2017). General social survey (GSS)") + 
  theme_minimal()
```
 
 From graph 2, we can clearly see that most respondents have zero or two children with proportions over 30%. As expected, the lowest proportion of respondents are seen with 4 or more children. The large number of respondents with zero children is surprising given the age proportions we saw earlier, however, this should not disturb our model's ability.
 
 
```{r, warning = FALSE}
# income distribution
gss %>% 
  group_by(income_respondent) %>% 
  summarise('number'=n(),"percentage"=n()/nrow(gss))
```

```{r}
# education distribution
gss %>% 
  group_by(education) %>% 
  summarise('number'=n(),"percentage"=n()/nrow(gss))
```
 
 As shown in table 3 and table 4, nearly a third of respondents earn less than 25,000 a year, with the next highest proportion seen earning between $25,000 and $49,999, while only 4 percent earn more than $125,000 a year. As for educational background, more than 50% of respondents had a college diploma or above, and only about 15 per cent had a lower educational level than high school level.
 We may end up running into problems with our model's statistical significance for the categories with the lowest proportions of respondents as there will be less data for our model to get a clear understanding of. This will likely result in these income and education options being less significant than their alternatives in determining expected number of children.
 
 


## Model Development

Due to this being a real survey, we can find many NA values in the responses that can prevent us from properly carrying out a regression analysis. To correct this we first selected only the variables of interest (total number of children, age, education, and respondent income) from our original data and made a new dataset of these. We then filtered the responses to these questions so that they would contain only complete cases and remove any NA responses. Doing this ensures that the length of our regression model's observations would match that of our cleaned dataset.

```{r}

gss_test <- gss
gss_test1 <- gss_test %>%
  dplyr::select(caseid, total_children, age,
         income_respondent, education)

gss_test2 <- gss_test1 %>% 
  na.omit() %>%
  filter(education != 'NA')

head(gss_test2)
```






The regression model we have chosen to use in this study is a generalized linear regression model of the negative binomial family. A generalized linear model is a generalization of ordinary linear regression which removes the assumptions made in the linear model. This model then allows us to link our response variable through a specified probability distribution, we refer to this distribution as the family of our regression model. Thus, unlike in linear regression, we do not need to have a normally distributed response variable, a requirement often not met by real data like ours.

We first made this choice as the independent variable we are studying, total children, is count based and not continuous which meant that ordinary least squares regression would not work as well. Many of our variables also violate the strong requirements for a linear regression model like homoscedasticity and normality of errors. Since generalized linear regression models do not feature these same requirements, this made it the ideal model option for our data. 

When it comes to determining a distribution family, the skewness of our data suggests that a poisson distribution might be suitable since it accounts for this. However, if we analyze the mean and variance of total children Mean = ___ Variance = ___ we notice that the variance is greater, meaning that our data is over dispersed. This violates the poisson model’s equal dispersion assumption and will negatively affect the effectiveness of our model. As this equal dispersion assumption is often unrealistic for real world data, we must use a probability distribution similar to poisson in shape, but without the harsh criterion. Thus, to account for this, we have decided to use a negative binomial probability distribution in our model. A negative binomial distribution shares almost the exact same shape as a poisson distribution but it does not make the same equal dispersion assumption. As it works well specifically with over-dispersed and skewed count data, which is exactly what we have, we decided to use a generalized linear regression model of the negative binomial family throughout our study.



Alternatively, at this step we could have chosen a zero inflated poisson regression model as we notice the number of respondents with zero total children is extremely large, at over 30% of our dataset. We decided against this, however, as we also see an almost equally large number of respondents with a total of two children as well as the strong overdispersion in our data which the zero inflated model could not account for.

As mentioned earlier, the explanatory variables we have chosen for our study are the respondent’s; age, education, and income bracket, as they are all extremely influential in determining one's social/economic status which is known to play a key role in the number of children in a family. Since age has already been recorded as a numerical value, we did not have to alter it to fit it into our model. However, for both education and respondent income, they are set up as categorical strings in our data, thus to allow them to function properly in our generalized linear model we first needed to apply the as.factor() function from the base R package to convert them into a factor form we can work with.

Final Model Code



## Model Validation

```{r}
set.seed(140)
gss_sample <- sample_n(gss_test2, 4000)
gss_test2_MSPE <- gss_test2 %>%
  anti_join(gss_sample)
length(gss_test2_MSPE$caseid)
```
```{r}
negbinmodel <- glm.nb(total_children ~ age + 
                        as.factor(education) + 
                        as.factor(income_respondent), 
                      data = gss_test2_MSPE)
```

```{r}
#Model validation, comparing MSPE and MSres
# fitting sample dataset to our model
gss_sample_glm <- glm.nb(total_children ~ age + 
                        as.factor(education) + 
                        as.factor(income_respondent),  
                      data = gss_sample)
                      
#calculation of the mspe for sample dataset
mspe = sum(resid(gss_sample_glm)^2)/ length(gss_sample$total_children)
#calculation of the MSres for our main dataset
msres = sum(resid(negbinmodel)^2)/(length(gss_test2_MSPE$total_children) - 13)
mspe
msres
```

In order to validate our model, as seen in the appendix, we initially divided the GSS dataset into a model validation dataset and a model development dataset. We decided that the model validation dataset should be roughly 20% of the cleaned GSS dataset at 4000 observations, leaving us with a total of 16244 respondents in our training set. Through running calculations in R, we found the  MSPE to be 1.223. Compared to the MSres from our model, which is 1.232, we find that the difference is only 0.009. An MSPE value that is close to the MSRes value based on the regression fit to the model-building data set, indicates a high predictive ability of the model. Thus, these results help to prove the validity of our model choice as the difference between these 2 values was incredibly small being less than 0.01.

```{r, include = FALSE}
cv.glm(gss_test2_MSPE, negbinmodel, K = 10)
```


# cv.glm(gss_test2, negbinmodel, K=10)
# [1] 1.795375 1.795206

Using a 10-fold cross validation analysis, we find that our cross validation estimate of prediction error is equal to 1.79. This means that, if we split our data up into 10 subsamples, cross validate using 1 of these subsamples as the testing dataset, and then perform this same process for each subsample, we would see an average prediction error of 1.79.

As a result of this relatively high value, our model's predictive ability will not be extremely strong as the error will likely cause us to under or overestimate the number of children we expect. This is likely due to the number of predictor variables we have chosen to include. These values suggest that there is still a lot of variance in the total number of children a family has, given their responses to these questions. By using more predictor variables we would be able to gain a more specific understanding of exactly what personal factors will result in the highest number of children in a family. Options we have considered include; age of the respondent at the birth of their first child, whether or not the respondent has a religious affiliation, and whether or not the respondent is currently married. The addition of these variables would require different regression models depending on dispersion in the data and the distribution of the response variable. While further research must be done to reach better predictive abilities, the estimates and data we have collected will still be able to tell us the relative significance of the response options and how they affect the total number of children we expect to see.





## Results

```{r}
summary(negbinmodel)
```

```{r}
summ(negbinmodel, vifs = TRUE, digits = 5, model.fit = FALSE)
```

To begin with,in Table 1, we display the output from the estimate of our model using summary statistics via the MASS(reference call) package. In order to interpret both the impact and the strength of our predictor variables we will pay attention to three key columns of our regression summary; Estimate, Z-value, and P-value. The coefficient estimate value will tell us the log change in the total number of children that we expect a respondent to have given change in the predictor's value. Next, the Z-values will tell us whether or not we can reject the null hypothesis, that our coefficient estimate is truly zero. Here, to conform with a 95% confidence interval, we will be looking for absolute values greater than 1.96. Lastly, a predictor's p value works with the z value to confirm our rejection of the null hypothesis. Keeping in line with the same 95% confidence interval we require values less than 0.05. Independant variables that satisfy both of the Z and p conditions we have described above, will in result reject the null hypothesis and prove to be significant predictors of the total number of children people have. We will discuss which specific predictors these are and their overall significance in the discussion section below.



Below, in Figure ____ We display the estimated values of our explanatory variables along with their standard errors as horizontal lines plotting the upper and lower bounds to the estimates.
```{r}
plot_summs(negbinmodel, scale= FALSE)
```

 Next, In Figure 6,  we can see the estimated coefficient values and their respective standard deviations. As described above, estimates are concerning the log change that we expect to have given a change in the predictor variables. The standard deviation tracks the variability between these estimates, and thus shows how precise they are. For age, we observe that the standard deviation is extremely and thus the estimate of the coefficient is likely very precise. Next for the level of education completed, we can see for the majority of categories, the standard deviation was relatively low, leading us to believe that the estimated coefficients for these categories are accurate. However, for "University certificate or diploma below the bachelor's level",  "University certificate or diploma above the bachelor's level" and "Trade certificate or diploma" had higher standard deviations than the other levels of education, thus we cannot trust their estimated coefficients as surely. Finally, for levels of annual income, we see that the standard deviation is relatively high in comparison to education. The average standard deviation for income categories was about 0.036 whereas education was only about 0.026, thus the estimates of the coefficients for variables in this category were the most imprecise. 


## Discussion

Based on the results obtained from our model, the impact and strength of the predictor variables can be determined by the three values of each predictor, namely, the estimate, the Z-value and the P-value. The estimates of the co-efficient values are basically the slopes of the regression equation, informing us of a logarithmic change in the total number of children that respondents intend to have, given a unit change in the predictor’s value. Considering a null hypothesis of zero, that is, there is no relationship between the predictors, age, education, and income and the response variable, we also look at the Z-values and P-values obtained for each predictor. The Z-value indicates the degree of uncertainty that surrounds the estimate of the co-efficient whereas the P-value also works with the Z-value and essentially allows us to verify the truth of the null hypothesis. In our analysis, we conform to a 95% confidence level thereby, desiring Z-values more than 1.96 and P-values less than 0.05 in order to reject the null hypothesis.
 
Age:
 
The estimated coefficient for the predictor "age" is 0.02415. It is a positive value indicating a change of 0.02415 in the logarithmic value of the total children in a family caused by a units change in the age of the respondent. A huge z-value of 67.49285 and an extremely p-value of 0.0000 allows us to reject the null hypothesis. It can be safely assumed that with an increase in age of the respondent, the total number of children increases. Having children is an extremely long process but even considering parenthood at a young age, families can still choose to have more children with maturity and age. Hence, the reality, very practically, conforms to the results derived from this model.
 
Education:
 
 Using the education level of Bachelor’s degree as conditional, we can think about the other values as the difference in the number of total children we would expect to see from a respondent with a different level of education. Analysing the results, it is very apparent that all the levels of education, when compared to the Bachelor’s degree, have positive estimates indicating a higher number of children in the family. However, when respondents achieve a Bachelor's degree or a degree above, the estimated value is -0.05890. The negative value suggests an inverse relationship between the education level and the number of children in the family. The general trend as observed from an educational degree at the Bachelor level or above is that a higher level of education, provides enough knowledge, maturity and understanding for the respondent to undertake family planning and reduce (in this case) or have children according to their capacity. . Obtaining a trade school certificate or less than a high school diploma resulted in the highest estimates at 0.18554 and  0.17617 respectively. Hence, a lower level of education deprives the respondents of accurate information or knowledge regarding family planning, in most cases which leads to the most number of children in these families compared to the families of respondents with a Bachelor’s degree or above.
 The z-values and the p-values for all education levels except a  University certificate or diploma below the bachelor's level, allow us to reject the null hypothesis. However, a University certificate or diploma below the bachelor’s level has a very high p-value of 0.07724 (> 0.05), disabling us from rejecting the null hypothesis. 
 
Income:
 
 Conditioning on the $100,000-$124,999 income bracket, we can interpret the estimates from the different income categories as differences in the total number of children expected in the family of a respondent with an income between $100,000 and $124,999 per year. We can observe that for income levels below $75,000, the estimates are negative, at -0.08241, and keeps decreasing as income decreases, with the smallest estimate at  -0.18074 for income below $25,000. This realistically indicates that lower the income, less would be the number of children in a respondent’s family as they would not have enough money to maintain or provide for their children. Moreover, the highest estimate of 0.02369 for income above $125,000 suggests that a higher income allows the respondent to comfortably provide for their children. Hence, such respondents have more children in their families.
 
 Examination of the z-values and p-values for the income levels reveal that for income less than $25,000 and the brackets of $25,000-$49,999 and $50,000-$74,999, the p-values are low enough to reject the null hypothesis. However, for income level above $75,000, the p-values are huge. Hence, we fail to reject the null hypothesis and cannot fully confirm or deny their significance.





# Weaknesses
- We notice that the number of respondents with 0 children was 

The most prominent limitation of our study is the fact that we are dealing with a survey where we must rely on total honesty from respondents. It would be extremely easy for respondents to falsify their answers, thereby making our conclusions less dependable. Since there is no way we can confirm the truthfulness of answers, we must assume that we have been provided with completely honest responses.
Another limitation of our model comes from the number of variables we have chosen for our study. By selecting so few questions out of a very long survey, we still end up seeing a large variability in the total number of children a respondent has given their responses. If we were to add additional questions into our model we would be able to gain a greater predictive ability and a higher significance of our estimates.
We could have chosen
As mentioned earlier, we can also expect some bias in our model given the distribution of the ages of respondents. To protect against this, we could have chosen a method to take a sample of our dataset that would provide a better representation of all age groups equally, however, this would have greatly reduced our model’s predictive ability as we would lose a significant number of observations.






## Interpretations

To interpret both the impact and the strength of our predictor variables we will pay attention to three key columns of our regression summary; Estimate, Z-value, and P-value. The coefficient estimate value will tell us the log change in the total number of children that we expect a respondent to have given a unit change in the predictor's value. Z-values will tell us whether or not we can reject the null hypothesis, that our coefficient estimate is truly zero. Here, to conform with a 95% confidence interval, we will be looking for absolute values greater than 1.96. Lastly, a predictor's p-value works with the z-value to confirm our rejection of the null hypothesis. Keeping in line with the same 95% confidence interval we require values less than 0.05.

AGE:
Estimate: 0.02415
With a coefficient estimate of 0.02415, this means we would expect to see a 0.02415 change in the log value of the total number of children in a family, given a one unit change in the respondent’s age. This suggests a positive relationship between a respondent’s age and the number of children in their family. When thinking about the real world, having even one child is a lengthy process and having more only requires a greater amount of time, this result was to be expected.
z and p values:
z = 67.49285 > 1.96
p = 0.00000 < 0.05
As both these values completely satisfy our conditions, we can safely reject the null hypothesis and conclude that a respondent's age is a significant predictor of the total number of children they have.

EDUCATION:
- Estimates:
These values are based off of a respondent that has earned a Bachelor's degree. Thus we think about them as the difference in the number of total children we expect to see from a respondent with a different level of education. As we analyze the coefficient estimates, we can begin to visualize a ranking of what level of education will lead to the highest predicted number of children. We first notice an obvious result, when compared to a Bachelor's degree level of education, almost all other options lead us to expect a higher number of children in a family. However, when respondents had achieved a level of education above the Bachelor's level we can actually see a decrease in the number of children expected. Looking more closely at the estimated results, we can start to see a general trend, the higher the level of education achieved, the fewer children we expect to see in the family. Obtaining a trade school certificate or less than a high school diploma resulted in the highest estimates at 0.18554 and  0.17617 respectively, suggesting that we would expect to see the most children in these families. Conversely, earning a degree above a Bachelor's results in the lowest coefficient estimate at -0.05890, and leading us to expect the fewest amount of children in a respondent's family.
Z and p-values
For all education options except a university certificate below the bachelor's level, we see our z and p-values satisfying both conditions, thus allowing us to confirm their significance and reject the null hypothesis that their estimate values are zero. As mentioned earlier, this was to be expected since the proportion of respondents that chose this option was relatively low.


INCOME:
- Estimates 
 Using the $100,000-$124,999 Income bracket as the one we condition on, we can interpret the estimates from our income categories as differences in the total number of children we expect in the family of a respondent with an income between $100,000 and $124,999 per year. Analyzing the coefficient estimates for different income categories suggests to us that, for the most part, having an income below the $100,000-$124,999 bracket leads to a lower prediction of total children in a family. As we can see, for income levels less than 25,000 and between $25,000-$49,999 their coefficient estimates are the lowest when compared to the $100,000-$124,999 income bracket, sitting at -0.18074 and -0.15031 respectively, suggesting that we would expect the fewest number of children in these families. When we examine income levels above $125,000 we see that we would actually expect a higher total number of children in a family, with an estimate of 0.02369, this helps to confirm the idea that lower levels of income lead to fewer children in a family.
Z and p values
Examining the z and p-values of our income brackets, we can see that for incomes; less than $25,000, between $25,000-$49,999, and between $50,000-74,999, both values satisfy the necessary conditions, suggesting that we can confirm their significance and reject the null hypothesis. For income brackets of more than $125,000 and between $75,000-99,999, however, both  values fail to satisfy the conditions and so we cannot fully confirm or deny their significance. As was the same case with the less significant education categories, the low proportion of respondents we saw in these income brackets is the likely explaination for their insignificance in our model.




The limitations of this article are mainly reflected in the biasedness of data and methodological weaknesses.
The biasedness of data collection is mainly caused by the single data collection method. The data is collected via phone. The biggest disadvantage of this collection method is that it ignores many people who do not have mobile phones or have multiple mobile phones. As the data shows, many of the respondents are middle-aged, while the young who prefer face-to-face communication and the elderly who cannot use mobile phones for various reasons are largely ignored.
 In this paper, we use linear regression to explore the relationship between age, income, education, and number of children. The main limitation of Linear Regression is the assumption of linearity between the dependent variable and the independent variables. In the real world, the data is rarely linearly separable. It assumes that there is a straight-line relationship between the dependent and independent variables which is incorrect many times.
 Although the data sources are reliable, there are inevitably some problems with such a large amount of data. For example, respondents may respond less positively and accurately to many long survey questions. Moreover, in this paper, a large amount of data was removed when calling filter function which results in a less predictable model. Therefore, to improve this paper, we can reduce the length of questions and questionnaires to improve the accuracy of data. Increase the method of data collection to ensure the universality of data; And using better models to predict the results of the data.